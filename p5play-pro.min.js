/**
 * p5play-pro
 * @version 0.0
 * @author quinton-ashley
 * @license AGPL-3.0
 */
p5.prototype.registerMethod("init",(function(){let e=this;this.Netcode=class{constructor(){this.typeSizes={boolean:1,Uint8:1,Vec2_boolean:1,Float16:2,number:2,color:4,Float32:4,Int32:4,Vec2:4,Float64:8},this._encodeFloat16=function(){let e=new Float32Array(1),t=new Int32Array(e.buffer);return function(o){e[0]=o;let n=t[0],i=n>>16&32768,s=n>>12&2047,r=n>>23&255;return r<103?i:r>142?(i|=31744,i|=(255==r?0:1)&&8388607&n,i):r<113?(s|=2048,i|=(s>>114-r)+(s>>113-r&1),i):(i|=r-112<<10|s>>1,i+=1&s,i)}}()}_decodeFloat16(e){let t=(31744&e)>>10,o=1023&e;return(e>>15?-1:1)*(t?31===t?o?NaN:1/0:Math.pow(2,t-15)*(1+o/1024):o/1024*6103515625e-14)}spriteToBytes(t){const o=e.Sprite.props;let n=3;for(let i=0;i<o.length;i++){if(t.watch&&!t.mod[i])continue;const s=o[i],r=e.Sprite.propTypes[s];let l=t[s];if(null!=l)if("string"==r){n+=(new TextEncoder).encode(l).length+3}else n+=this.typeSizes[r]+1}if(3==n)return null;const i=new ArrayBuffer(n),s=new DataView(i);s.setFloat16=(e,t)=>s.setUint16(e,this._encodeFloat16(t)),s.setUint16(0,t._uid);let r=2;for(let n=0;n<o.length;n++){if(t.watch&&!t.mod[n])continue;const i=o[n],l=e.Sprite.propTypes[i];let a=t[i];if(null!=a){if(s.setUint8(r,n),r+=1,"boolean"==l)s.setUint8(r,a?1:0);else if("number"==l||"Float16"==l)"rotation"==i&&(a>2048||a<-2048)&&(a%=2048,t[i]=a),s.setFloat16(r,a);else if("Float32"==l)s.setFloat32(r,a);else if("Float64"==l)s.setFloat64(r,a);else{if("string"==l){const e=(new TextEncoder).encode(a);s.setUint16(r,e.length),r+=2;for(let t=0;t<e.length;t++)s.setUint8(r,e[t]),r+=1;continue}"color"==l?(s.setUint8(r,a.levels[0]),s.setUint8(r+1,a.levels[1]),s.setUint8(r+2,a.levels[2]),s.setUint8(r+3,a.levels[3])):"Vec2"==l?(s.setFloat16(r,a.x),s.setFloat16(r+2,a.y)):"Vec2_boolean"==l?s.setUint8(r,(a.x?1:0)|(a.y?2:0)):"Uint8"==l?"collider"==i?s.getUint8(r,t.__collider):"shape"==i?s.getUint8(r,t.__shape):s.getUint8(r,a):"Int32"==l&&s.setInt32(r,a)}r+=this.typeSizes[l]}}return s.setUint8(r,255),t.watch=!0,t.mod={},new Uint8Array(i)}bytesToSprite(t){let o;o=t instanceof DataView?t:new DataView(t.buffer),o.getFloat16=e=>this._decodeFloat16(o.getUint16(e));let n=o.offset||0,i=o.getUint16(n);n+=2;let s=e.p5play.sprites[i]||new e.Sprite;for(;n<o.byteLength;){const t=o.getUint8(n);if(n+=1,255===t)break;const i=e.Sprite.props[t],r=e.Sprite.propTypes[i];if(!i||!r){console.error(`Unknown property type: ${t}`);break}if("boolean"===r)s[i]=0!==o.getUint8(n);else if("number"==r||"Float16"===r)s[i]=o.getFloat16(n);else if("Float32"===r)s[i]=o.getFloat32(n);else if("Float64"===r)s[i]=o.getFloat64(n);else{if("string"===r){const e=o.getUint16(n);n+=2;const t=new Uint8Array(o.buffer,n,e);s[i]=(new TextDecoder).decode(t),n+=e;continue}if("color"===r){const e=o.getUint8(n),t=o.getUint8(n+1),r=o.getUint8(n+2),l=o.getUint8(n+3);s[i]=color(e,t,r,l)}else if("Vec2"===r){const e=o.getFloat16(n),t=o.getFloat16(n+2);s[i]={x:e,y:t}}else if("Vec2_boolean"===r){const e=o.getUint8(n);s[i]={x:!(1&~e),y:!(2&~e)}}else if("Uint8"===r){let t=o.getUint8(n);"collider"===i?s.collider=e.Sprite.colliderTypes[t]:"shape"===i?s.shape=e.Sprite.shapeTypes[t]:s[i]=t}else"Int32"===r&&(s[i]=o.getInt32(n))}n+=this.typeSizes[r]}return o.offset=n,s}worldToBytes(){let t=[],o=0;for(let n in e.p5play.sprites){let i=e.p5play.sprites[n],s=this.spriteToBytes(i);s&&(t.push(s),o+=s.length)}let n=new Uint8Array(o),i=0;for(let e of t)n.set(e,i),i+=e.length;return n}bytesToWorld(e){let t=[],o=new DataView(e.buffer);for(o.offset=0;o.offset<e.byteLength;){let e=this.bytesToSprite(o);t.push(e)}return t}spriteToBlob(e){const t=this.spriteToBytes(e);return new Blob([t],{type:"application/octet-stream"})}async blobToSprite(e){const t=new Uint8Array(await e.arrayBuffer());return this.bytesToSprite(t)}worldToBlob(){let e=this.worldToBytes();return new Blob([e.buffer],{type:"application/octet-stream"})}async blobToWorld(e){let t=new Uint8Array(await e.arrayBuffer());return this.bytesToWorld(t)}encodeWorld(){return this.worldToBytes()}syncWorld(e){return this.blobToWorld(e)}encodePlayerInput(){}},this.netcode=new this.Netcode,this.loadAds=e=>{e??={},window.webkit&&webkit.messageHandlers.loadAds.postMessage(JSON.stringify(e))},this.showAd=e=>{e&&(e=e.toLowerCase()),e??="interstitial",window.webkit&&confirm("p5play:"+e)}}));
